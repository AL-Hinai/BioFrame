# Complete Phylogenomics Pipeline
# Combines gene recovery and phylogenetic analysis into a single workflow

workflow_name: "Complete Phylogenomics Pipeline"
workflow_description: "End-to-end phylogenomics analysis from raw sequencing data to species trees"
workflow_version: "1.0"
workflow_author: "BioFrame Team"
workflow_category: "Complete Phylogenomics"

# Pipeline steps
steps:
  - step_number: 1
    step_name: "Quality Control"
    tool_name: "trimmomatic"
    description: "Quality trimming of raw sequencing reads"
    input_types: ["FASTQ"]
    output_types: ["FASTQ"]
    parameters:
      mode: "PE"
      trimming_options: ["ILLUMINACLIP:/adapters/TruSeq3-PE.fa:2:30:10", "LEADING:3", "TRAILING:3", "SLIDINGWINDOW:4:15", "MINLEN:36"]
      threads: 4

  - step_number: 2
    step_name: "Gene Recovery"
    tool_name: "paftools"
    description: "Extract genes from sequencing reads"
    input_types: ["FASTQ"]
    output_types: ["FASTA"]
    parameters:
      method: "paftools"
      target_genes: "auto"
      output_format: "fasta"

  - step_number: 3
    step_name: "Sequence Processing"
    tool_name: "seqtk"
    description: "Process and format recovered gene sequences"
    input_types: ["FASTA"]
    output_types: ["FASTA"]
    parameters:
      subcommand: "seq"
      format: "fasta"

  - step_number: 4
    step_name: "Multiple Sequence Alignment"
    tool_name: "mafft"
    description: "Align gene sequences across all samples"
    input_types: ["FASTA"]
    output_types: ["FASTA", "ALN"]
    parameters:
      algorithm: "auto"
      output_format: "fasta"
      threads: 4
      options: ["--auto", "--reorder"]

  - step_number: 5
    step_name: "Alignment Quality Control"
    tool_name: "trimal"
    description: "Trim alignments and remove low-quality regions"
    input_types: ["FASTA", "ALN"]
    output_types: ["FASTA"]
    parameters:
      method: "automated1"
      gap_threshold: 0.1
      similarity_threshold: 0.1

  - step_number: 6
    step_name: "Gene Tree Construction"
    tool_name: "iqtree"
    description: "Build individual gene trees with model selection"
    input_types: ["FASTA"]
    output_types: ["NEWICK", "LOG"]
    parameters:
      model: "MFP"
      bootstrap: 1000
      threads: 4
      options: ["-bb", "1000", "-nt", "4"]

  - step_number: 7
    step_name: "Species Tree Construction - ASTRAL"
    tool_name: "astral"
    description: "Construct species tree from gene trees using ASTRAL"
    input_types: ["NEWICK"]
    output_types: ["NEWICK", "LOG"]
    parameters:
      method: "astral"
      bootstrap: 100
      options: ["-i", "gene_trees.nwk", "-o", "species_tree_astral.nwk"]

  - step_number: 8
    step_name: "Species Tree Construction - Concatenated"
    tool_name: "iqtree"
    description: "Build species tree from concatenated alignments"
    input_types: ["FASTA"]
    output_types: ["NEWICK", "LOG"]
    parameters:
      model: "MFP"
      bootstrap: 1000
      threads: 4
      options: ["-bb", "1000", "-nt", "4", "-s", "concatenated_alignment.fasta"]

  - step_number: 9
    step_name: "Tree Comparison and Validation"
    tool_name: "tree_comparator"
    description: "Compare different tree reconstruction methods"
    input_types: ["NEWICK"]
    output_types: ["PDF", "HTML", "TXT"]
    parameters:
      methods: ["astral", "concatenated"]
      output_format: "pdf"

  - step_number: 10
    step_name: "Results Summary"
    tool_name: "phylogenomics_reporter"
    description: "Generate comprehensive analysis report"
    input_types: ["NEWICK", "FASTA", "LOG"]
    output_types: ["HTML", "PDF", "TXT"]
    parameters:
      include_alignments: true
      include_trees: true
      include_statistics: true

# Workflow configuration
workflow_config:
  parallel_execution: true
  error_handling: "continue_on_error"
  resource_requirements:
    memory: "32GB"
    cpu_cores: 16
    storage: "100GB"
  
  # Input validation
  input_validation:
    required_formats: ["FASTQ"]
    min_samples: 3
    max_samples: 1000
    min_file_size: "1MB"
    max_file_size: "50GB"
  
  # Output configuration
  output_config:
    create_summary: true
    generate_reports: true
    compress_outputs: true
    include_alignments: true
    include_trees: true
    include_logs: true

# Tool dependencies
dependencies:
  - name: "trimmomatic"
    version: "0.39"
    required: true
  - name: "paftools"
    version: "1.0"
    required: true
  - name: "seqtk"
    version: "1.3"
    required: true
  - name: "mafft"
    version: "7.505"
    required: true
  - name: "iqtree"
    version: "2.2.0"
    required: true
  - name: "astral"
    version: "5.7.8"
    required: true
  - name: "fasttree"
    version: "2.1.11"
    required: false

# Advanced configuration
advanced_config:
  # Memory management for large datasets
  memory_optimization:
    large_gene_threshold: 1000
    memory_per_gene: "2GB"
    parallel_gene_processing: true
  
  # Quality control thresholds
  quality_control:
    min_sequence_length: 100
    max_gap_percentage: 50
    min_taxa_per_gene: 3
    bootstrap_threshold: 70
  
  # Tree optimization
  tree_optimization:
    treeshrink: true
    long_branch_detection: true
    bootstrap_filtering: true
    support_threshold: 15

# Example usage
example_usage:
  command: "python manage.py run_workflow complete_phylogenomics_pipeline --input samples/*.fastq --output results/ --target_genes genes.txt"
  description: "Run complete phylogenomics analysis on all samples with specified target genes"
