{% extends 'bioframe/base.html' %}
{% load static %}

{% block title %}Workflow Details - {{ workflow.name }} - BioFrame{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">{{ workflow.name }}</h1>
                    <p class="mt-2 text-gray-600">{{ workflow.description }}</p>
                </div>
                <div class="flex space-x-3">
                    {% if workflow.status == 'pending' %}
                    <button onclick="startWorkflow()" 
                            class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md transition duration-200">
                        <i class="fas fa-play mr-2"></i>Start Workflow
                    </button>
                    {% elif workflow.status == 'running' %}
                    <button onclick="refreshStatus()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh Status
                    </button>
                    {% elif workflow.status == 'completed' %}
                    <button onclick="downloadResults()" 
                            class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-md transition duration-200">
                        <i class="fas fa-download mr-2"></i>Download Results
                    </button>
                    {% endif %}
                    <a href="{% url 'workflow_list' %}" 
                       class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-md transition duration-200">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Workflows
                    </a>
                </div>
            </div>
        </div>

        <!-- Workflow Status Overview -->
        <div class="bg-white shadow rounded-lg p-6 mb-8">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Workflow Status Overview</h3>
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600">{{ workflow.progress|floatformat:1 }}%</div>
                    <div class="text-sm text-gray-600">Progress</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold {% if workflow.status == 'completed' %}text-green-600{% elif workflow.status == 'running' %}text-blue-600{% elif workflow.status == 'failed' %}text-red-600{% else %}text-gray-600{% endif %}">
                        {{ workflow.status|title }}
                    </div>
                    <div class="text-sm text-gray-600">Status</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600">{{ workflow.tools|length }}</div>
                    <div class="text-sm text-gray-600">Total Tools</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-purple-600">{{ workflow.created_at|date:"M d, Y" }}</div>
                    <div class="text-sm text-gray-600">Created</div>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="mt-4">
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div class="bg-blue-600 h-3 rounded-full transition-all duration-500" 
                         style="width: {{ workflow.progress }}%"></div>
                </div>
                <div class="text-sm text-gray-600 mt-2 text-center">
                    {{ workflow.progress|floatformat:1 }}% Complete
                </div>
            </div>
        </div>

        <!-- Workflow Pipeline Execution -->
        <div class="bg-white shadow rounded-lg p-6 mb-8">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Pipeline Execution Details</h3>
            <div class="space-y-4">
                {% for tool in workflow.tools %}
                <div class="flex items-center space-x-4 p-4 border border-gray-200 rounded-lg {% if tool.status == 'completed' %}bg-green-50 border-green-200{% elif tool.status == 'running' %}bg-blue-50 border-blue-200{% elif tool.status == 'failed' %}bg-red-50 border-red-200{% else %}bg-gray-50 border-gray-200{% endif %}" data-tool="{{ tool.tool_name }}">
                    <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center {% if tool.status == 'completed' %}bg-green-100 text-green-600{% elif tool.status == 'running' %}bg-blue-100 text-blue-600{% elif tool.status == 'failed' %}bg-red-100 text-red-600{% else %}bg-gray-100 text-gray-600{% endif %}">
                        {% if tool.status == 'completed' %}
                            <i class="fas fa-check text-lg"></i>
                        {% elif tool.status == 'running' %}
                            <i class="fas fa-spinner fa-spin text-lg"></i>
                        {% elif tool.status == 'failed' %}
                            <i class="fas fa-times text-lg"></i>
                        {% else %}
                            <span class="text-sm font-medium">{{ tool.order }}</span>
                        {% endif %}
                    </div>
                    <div class="flex-1">
                        <h4 class="font-medium text-gray-900">{{ tool.tool_name|title }}</h4>
                        <p class="text-sm text-gray-600">Step {{ tool.order }} - {{ tool.status|title }}</p>
                        {% if tool.error_message %}
                            <p class="text-sm text-red-600 mt-1 tool-error">
                                <i class="fas fa-exclamation-triangle mr-1"></i>{{ tool.error_message }}
                            </p>
                        {% else %}
                            <p class="text-sm text-red-600 mt-1 tool-error" style="display: none;"></p>
                        {% endif %}
                        {% if tool.input_files %}
                            <p class="text-xs text-gray-500 mt-1">
                                <strong>Input:</strong> {{ tool.input_files|length }} file(s)
                            </p>
                        {% endif %}
                        {% if tool.output_files %}
                            <p class="text-xs text-gray-500 mt-1">
                                <strong>Output:</strong> {{ tool.output_files|length }} file(s)
                            </p>
                        {% endif %}
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-medium text-gray-900 tool-status">{{ tool.status|title }}</div>
                        {% if tool.execution_time %}
                            <div class="text-xs text-gray-500 tool-time">{{ tool.execution_time|floatformat:3 }}s</div>
                        {% else %}
                            <div class="text-xs text-gray-500 tool-time">-</div>
                        {% endif %}
                        {% if tool.started_at %}
                            <div class="text-xs text-gray-400">{{ tool.started_at|date:"H:i:s" }}</div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- File Outputs and Results -->
        <div class="bg-white shadow rounded-lg p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Generated Files & Results</h3>
                <button onclick="refreshFileOutputs()" 
                        class="text-sm text-blue-600 hover:text-blue-800">
                    <i class="fas fa-refresh mr-1"></i>Refresh
                </button>
            </div>
            <div id="file-outputs" class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-file-alt text-3xl mb-2"></i>
                    <p>Loading file outputs...</p>
                </div>
            </div>
        </div>

        <!-- Live Execution Logs -->
        <div class="bg-white shadow rounded-lg p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Execution Logs & Status</h3>
                <div class="flex space-x-2">
                    <button onclick="clearLogs()" 
                            class="text-sm text-gray-500 hover:text-gray-700">
                        <i class="fas fa-trash mr-1"></i>Clear Logs
                    </button>
                    <button onclick="toggleAutoScroll()" 
                            id="auto-scroll-btn"
                            class="text-sm text-blue-600 hover:text-blue-800">
                        <i class="fas fa-lock mr-1"></i>Auto-scroll
                    </button>
                </div>
            </div>
            
            <!-- Tool-specific logs -->
            <div class="mb-4">
                {% for tool in workflow.tools %}
                <div class="mb-3 p-3 border rounded-lg {% if tool.status == 'failed' %}border-red-200 bg-red-50{% elif tool.status == 'completed' %}border-green-200 bg-green-50{% elif tool.status == 'running' %}border-blue-200 bg-blue-50{% else %}border-gray-200 bg-gray-50{% endif %}">
                    <h4 class="font-medium text-gray-900 mb-2">
                        <i class="fas fa-cog mr-2"></i>{{ tool.tool_name|title }} - {{ tool.status|title }}
                        {% if tool.execution_time %}
                        <span class="text-sm text-gray-500">({{ tool.execution_time|floatformat:3 }}s)</span>
                        {% endif %}
                    </h4>
                    
                    {% if tool.error_message %}
                    <div class="mb-2 p-2 bg-red-100 border border-red-200 rounded text-red-800 text-sm">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <strong>Error:</strong> {{ tool.error_message }}
                    </div>
                    {% endif %}
                    
                    {% if tool.logs %}
                    <div class="text-xs text-gray-700 font-mono bg-white p-2 rounded border max-h-32 overflow-y-auto">
                        {% for log in tool.logs %}
                        <div class="mb-1">{{ log }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            
            <!-- Execution Logs from Files -->
            <div class="mb-4">
                <h4 class="font-medium text-gray-900 mb-2">
                    <i class="fas fa-file-alt mr-2"></i>Execution Log Files
                </h4>
                <div id="execution-logs-container">
                    {% if execution_logs %}
                        {% for log in execution_logs %}
                        <div class="mb-2 p-2 bg-gray-50 border border-gray-200 rounded">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm font-medium text-gray-700">{{ log.file }}</span>
                                <span class="text-xs text-gray-500">{{ log.timestamp|date:"H:i:s" }}</span>
                            </div>
                            <div class="text-xs text-gray-600 font-mono bg-white p-2 rounded border max-h-32 overflow-y-auto">
                                <pre>{{ log.content }}</pre>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-gray-500 py-4">
                            <i class="fas fa-file-alt text-2xl mb-2"></i>
                            <p>No execution logs available yet</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Live log container -->
            <div id="log-container" class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm h-96 overflow-y-auto">
                <div class="text-gray-500">
                    <i class="fas fa-terminal mr-2"></i>
                    Live execution logs will appear here when workflow is running...
                </div>
            </div>
            <div class="mt-2 text-xs text-gray-500">
                <i class="fas fa-info-circle mr-1"></i>
                Logs are automatically updated every 2 seconds when workflow is running
            </div>
        </div>

        <!-- Workflow Information -->
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Workflow Information</h3>
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                <div>
                    <h4 class="font-medium text-gray-900">Run Directory</h4>
                    <p class="text-sm text-gray-600 font-mono">{{ workflow.run_directory }}</p>
                </div>
                <div>
                    <h4 class="font-medium text-gray-900">Workflow ID</h4>
                    <p class="text-sm text-gray-600 font-mono">{{ workflow.id }}</p>
                </div>
                <div>
                    <h4 class="font-medium text-gray-900">Created</h4>
                    <p class="text-sm text-gray-600">{{ workflow.created_at|date:"F d, Y H:i:s" }}</p>
                </div>
                <div>
                    <h4 class="font-medium text-gray-900">Last Updated</h4>
                    <p class="text-sm text-gray-600" id="last-updated">
                        {% if workflow.updated_at %}{{ workflow.updated_at|date:"F d, Y H:i:s" }}{% else %}Never{% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let logContainer = document.getElementById('log-container');
let fileOutputs = document.getElementById('file-outputs');
let autoScroll = true;
let logPollingInterval;
let statusPollingInterval;

// Workflow ID from URL
const workflowId = '{{ workflow.id }}';

// Start workflow execution
async function startWorkflow() {
    try {
        addLog('🚀 Starting workflow execution...', 'info');
        
        const response = await fetch(`/workflows/${workflowId}/start/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        if (response.ok) {
            addLog('✅ Workflow started successfully', 'success');
            startStatusPolling();
            startLogPolling();
        } else {
            addLog('❌ Failed to start workflow', 'error');
        }
    } catch (error) {
        console.error('Error starting workflow:', error);
        addLog('❌ Error starting workflow: ' + error.message, 'error');
    }
}

// Refresh workflow status
async function refreshStatus() {
    try {
        const response = await fetch(`/workflows/${workflowId}/status/`);
        if (response.ok) {
            const data = await response.json();
            updateWorkflowStatus(data);
        }
    } catch (error) {
        console.error('Error refreshing status:', error);
    }
}

// Download workflow results
function downloadResults() {
    addLog('📥 Preparing results download...', 'info');
    // Implementation for downloading results
}

// Add log entry with timestamp and styling
function addLog(message, level = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const levelClass = {
        'info': 'text-blue-400',
        'success': 'text-green-400',
        'warning': 'text-yellow-400',
        'error': 'text-red-400'
    }[level] || 'text-blue-400';
    
    const logEntry = document.createElement('div');
    logEntry.className = `mb-1 ${levelClass}`;
    logEntry.innerHTML = `[${timestamp}] ${message}`;
    
    logContainer.appendChild(logEntry);
    
    if (autoScroll) {
        logContainer.scrollTop = logContainer.scrollHeight;
    }
}

// Clear logs
function clearLogs() {
    logContainer.innerHTML = '<div class="text-gray-500"><i class="fas fa-terminal mr-2"></i>Logs cleared...</div>';
}

// Toggle auto-scroll
function toggleAutoScroll() {
    autoScroll = !autoScroll;
    const btn = document.getElementById('auto-scroll-btn');
    if (autoScroll) {
        btn.innerHTML = '<i class="fas fa-lock mr-1"></i>Auto-scroll';
        btn.className = 'text-sm text-blue-600 hover:text-blue-800';
    } else {
        btn.innerHTML = '<i class="fas fa-unlock mr-1"></i>Auto-scroll';
        btn.className = 'text-sm text-red-600 hover:text-red-800';
    }
}

// Start status polling
function startStatusPolling() {
    statusPollingInterval = setInterval(async () => {
        try {
            const response = await fetch(`/workflow/${workflowId}/status/`);
            if (response.ok) {
                const data = await response.json();
                updateWorkflowStatus(data);
                
                // Update tool status and error messages
                updateToolStatus(data.tools);
                
                // Update execution logs
                if (data.execution_logs) {
                    updateExecutionLogs(data.execution_logs);
                }
                
                // Stop polling if workflow is completed or failed
                if (data.status === 'completed' || data.status === 'failed') {
                    clearInterval(statusPollingInterval);
                    addLog('🏁 Workflow execution finished', 'success');
                }
            }
        } catch (error) {
            console.error('Error polling status:', error);
        }
    }, 2000);
}

// Start log polling
function startLogPolling() {
    logPollingInterval = setInterval(async () => {
        try {
            const response = await fetch(`/workflows/${workflowId}/logs/`);
            if (response.ok) {
                const logs = await response.json();
                logs.forEach(log => {
                    addLog(log.message, log.level);
                });
            }
        } catch (error) {
            console.error('Error fetching logs:', error);
        }
    }, 2000);
}

// Update workflow status display
function updateWorkflowStatus(data) {
    // Update progress bar
    const progressBar = document.querySelector('.bg-blue-600');
    if (progressBar) {
        progressBar.style.width = data.progress + '%';
    }
    
    // Update status text
    const statusElement = document.querySelector('.text-2xl.font-bold');
    if (statusElement) {
        statusElement.textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
        statusElement.className = `text-2xl font-bold ${
            data.status === 'completed' ? 'text-green-600' : 
            data.status === 'running' ? 'text-blue-600' : 
            data.status === 'failed' ? 'text-red-600' : 'text-gray-600'
        }`;
    }
    
    // Update progress percentage
    const progressElement = document.querySelector('.text-2xl.font-bold.text-blue-600');
    if (progressElement) {
        progressElement.textContent = data.progress.toFixed(1) + '%';
    }
    
    // Update last updated timestamp
    const lastUpdatedElement = document.getElementById('last-updated');
    if (lastUpdatedElement && data.updated_at) {
        lastUpdatedElement.textContent = new Date(data.updated_at).toLocaleString();
    }
}

// Update tool status and error messages
function updateToolStatus(tools) {
    if (!tools) return;
    
    tools.forEach(tool => {
        const toolElement = document.querySelector(`[data-tool="${tool.tool_name}"]`);
        if (toolElement) {
            // Update tool status
            const statusElement = toolElement.querySelector('.tool-status');
            if (statusElement) {
                statusElement.textContent = tool.status.charAt(0).toUpperCase() + tool.status.slice(1);
                statusElement.className = `text-sm font-medium text-gray-900 tool-status ${
                    tool.status === 'completed' ? 'text-green-600' : 
                    tool.status === 'running' ? 'text-blue-600' : 
                    tool.status === 'failed' ? 'text-red-600' : 'text-gray-600'
                }`;
            }
            
            // Update error message if present
            if (tool.error_message) {
                const errorElement = toolElement.querySelector('.tool-error');
                if (errorElement) {
                    errorElement.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i><strong>Error:</strong> ${tool.error_message}`;
                    errorElement.style.display = 'block';
                }
            }
            
            // Update execution time
            if (tool.execution_time) {
                const timeElement = toolElement.querySelector('.tool-time');
                if (timeElement) {
                    timeElement.textContent = tool.execution_time.toFixed(3) + 's';
                }
            }
        }
    });
}

// Update execution logs from files
function updateExecutionLogs(executionLogs) {
    if (!executionLogs || executionLogs.length === 0) return;
    
    const logsContainer = document.getElementById('execution-logs-container');
    if (!logsContainer) return;
    
    logsContainer.innerHTML = '';
    
    executionLogs.forEach(log => {
        const logElement = document.createElement('div');
        logElement.className = 'mb-2 p-2 bg-gray-50 border border-gray-200 rounded';
        logElement.innerHTML = `
            <div class="flex items-center justify-between mb-1">
                <span class="text-sm font-medium text-gray-700">${log.file}</span>
                <span class="text-xs text-gray-500">${new Date(log.timestamp * 1000).toLocaleTimeString()}</span>
            </div>
            <div class="text-xs text-gray-600 font-mono bg-white p-2 rounded border max-h-32 overflow-y-auto">
                <pre>${log.content}</pre>
            </div>
        `;
        logsContainer.appendChild(logElement);
    });
}

// Load file outputs
async function loadFileOutputs() {
    try {
        const response = await fetch(`/workflows/${workflowId}/files/`);
        if (response.ok) {
            const files = await response.json();
            renderFileOutputs(files);
        } else {
            renderFileOutputs([]);
        }
    } catch (error) {
        console.error('Error loading file outputs:', error);
        renderFileOutputs([]);
    }
}

// Refresh file outputs
function refreshFileOutputs() {
    loadFileOutputs();
}

// Render file outputs
function renderFileOutputs(files) {
    fileOutputs.innerHTML = '';
    
    if (files.length === 0) {
        fileOutputs.innerHTML = `
            <div class="col-span-full text-center text-gray-500 py-8">
                <i class="fas fa-file-alt text-3xl mb-2"></i>
                <p>No files generated yet</p>
                <p class="text-sm">Files will appear here as the workflow executes</p>
            </div>
        `;
        return;
    }
    
    files.forEach(file => {
        const fileCard = document.createElement('div');
        fileCard.className = 'bg-gray-50 border border-gray-200 rounded-lg p-4 hover:bg-gray-100 transition-colors';
        
        const fileIcon = getFileIcon(file.name);
        const fileSize = formatFileSize(file.size);
        
        fileCard.innerHTML = `
            <div class="flex items-center space-x-3">
                <div class="flex-shrink-0">
                    <i class="${fileIcon} text-2xl text-gray-400"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 truncate">${file.name}</p>
                    <p class="text-sm text-gray-500">${fileSize}</p>
                    <p class="text-xs text-gray-400">${file.tool || 'Generated'}</p>
                </div>
                <div class="flex-shrink-0">
                    <a href="${file.download_url || '#'}" 
                       class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                        <i class="fas fa-download mr-1"></i>Download
                    </a>
                </div>
            </div>
        `;
        
        fileOutputs.appendChild(fileCard);
    });
}

// Get appropriate icon for file type
function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    if (['html', 'htm'].includes(ext)) return 'fas fa-file-code';
    if (['fastq', 'fq', 'fasta', 'fa'].includes(ext)) return 'fas fa-dna';
    if (['zip', 'gz', 'tar'].includes(ext)) return 'fas fa-file-archive';
    if (['log', 'txt'].includes(ext)) return 'fas fa-file-alt';
    if (['png', 'jpg', 'jpeg', 'svg'].includes(ext)) return 'fas fa-file-image';
    return 'fas fa-file';
}

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Load initial data
    loadFileOutputs();
    
    // Start polling if workflow is running
    if ('{{ workflow.status }}' === 'running') {
        startStatusPolling();
        startLogPolling();
        addLog('🔄 Workflow is currently running...', 'info');
    } else if ('{{ workflow.status }}' === 'completed') {
        addLog('✅ Workflow completed successfully', 'success');
    } else if ('{{ workflow.status }}' === 'failed') {
        addLog('❌ Workflow failed during execution', 'error');
    } else {
        addLog('⏳ Workflow is pending execution', 'info');
    }
    
    // Add initial log entry
    addLog('📋 Workflow detail page loaded', 'info');
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (statusPollingInterval) clearInterval(statusPollingInterval);
    if (logPollingInterval) clearInterval(logPollingInterval);
});
</script>
{% endblock %}


