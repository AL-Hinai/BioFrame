{% extends 'bioframe/base.html' %}
{% load static %}

{% block title %}Initialize Workflow Run - {{ template.name }} - BioFrame{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center">
                <a href="{% url 'workflow_list' %}" class="text-blue-600 hover:text-blue-800 mr-4">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Templates
                </a>
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Initialize Workflow Run</h1>
                    <p class="mt-2 text-gray-600">Set up and start your {{ template.name }} workflow</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Form -->
            <div class="lg:col-span-2">
                <div class="bg-white shadow rounded-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6">Run Configuration</h2>
                    
                    <!-- Enhanced Upload Form -->
                    <div id="upload-form">
                        <!-- Basic Information -->
                        <div class="space-y-6">
                            <div>
                                <label for="run_name" class="block text-sm font-medium text-gray-700">Run Name *</label>
                                <input type="text" name="run_name" id="run_name" required
                                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="e.g., My Quality Control Run">
                                <p class="mt-1 text-sm text-gray-500">Give your workflow run a descriptive name</p>
                            </div>
                            
                            <div>
                                <label for="run_description" class="block text-sm font-medium text-gray-700">Description</label>
                                <textarea name="run_description" id="run_description" rows="3"
                                          class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                          placeholder="Optional description of this specific run...">{{ template.description }}</textarea>
                            </div>
                            
                            <!-- Pipeline File Upload Section -->
                            <div>
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Pipeline Input Files</h3>
                                <p class="text-sm text-gray-600 mb-4">Upload your primary input files. Each tool's output will automatically become the input for the next tool in the pipeline.</p>
                                
                                <div class="space-y-6">
                                    <!-- Primary Input Files (for first tool) -->
                                    <div class="border-2 border-blue-200 rounded-lg p-4 bg-blue-50">
                                        <div class="flex items-center mb-3">
                                            <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center mr-3">
                                                <i class="fas fa-upload text-white text-sm"></i>
                                            </div>
                                            <div>
                                                <h4 class="font-semibold text-blue-900">Primary Input Files</h4>
                                                <p class="text-sm text-blue-700">These files will be processed by the first tool in your pipeline</p>
                                            </div>
                                        </div>
                                        
                                        <div class="space-y-3">
                                            <div>
                                                <label class="block text-sm font-medium text-blue-800">Upload Input Files</label>
                                                <div id="drop-zone" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-blue-300 border-dashed rounded-md bg-white hover:bg-blue-50 transition-colors duration-200 cursor-pointer">
                                                    <div class="space-y-1 text-center">
                                                        <i class="fas fa-cloud-upload-alt text-blue-400 text-3xl mb-2"></i>
                                                        <div class="flex text-sm text-blue-600">
                                                            <label for="primary-files" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                                                                <span>Browse files</span>
                                                                <input id="primary-files" name="primary_files" type="file" class="sr-only" multiple accept=".fastq,.fastq.gz,.fq,.fq.gz,.fasta,.fa,.fa.gz,.bam,.sam,.vcf,.gtf,.gff">
                                                            </label>
                                                            <p class="pl-1">or drag and drop here</p>
                                                        </div>
                                                        <p class="text-xs text-blue-500">
                                                            {% if template.id == 'quality-control-pipeline' or template.id == 'assembly-pipeline' or template.id == 'metagenomics-pipeline' or template.id == 'rna-seq-pipeline' %}
                                                            FASTQ, FASTQ.GZ files
                                                            {% elif template.id == 'variant-calling-pipeline' %}
                                                            FASTQ, FASTQ.GZ, FASTA reference
                                                            {% elif template.id == 'phylogenetics-pipeline' %}
                                                            FASTA, PHYLIP files
                                                            {% else %}
                                                            Various formats
                                                            {% endif %}
                                                        </p>
                                                        <p class="text-xs text-gray-400 mt-2">Drop files here or click to browse</p>
                                                    </div>
                                                </div>
                                                <div id="primary-files-list" class="mt-2 space-y-1"></div>
                                            </div>
                                            
                                            <div>
                                                <label class="block text-sm font-medium text-blue-800">Additional Parameters (Optional)</label>
                                                <textarea class="mt-1 block w-full border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                                          rows="2" placeholder="Additional parameters for the first tool..."></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Pipeline Flow Visualization -->
                                    <div class="border border-gray-200 rounded-lg p-4">
                                        <h4 class="font-medium text-gray-900 mb-3">Pipeline Flow</h4>
                                        <div class="space-y-3">
                                            {% for tool in template.tools %}
                                            <div class="flex items-center space-x-3">
                                                <div class="flex-shrink-0 w-8 h-8 {% if forloop.first %}bg-green-600{% elif forloop.last %}bg-purple-600{% else %}bg-blue-600{% endif %} rounded-full flex items-center justify-center">
                                                    <span class="text-sm font-medium text-white">{{ forloop.counter }}</span>
                                                </div>
                                                <div class="flex-1">
                                                    <h5 class="font-medium text-gray-900">{{ tool|title }}</h5>
                                                    <p class="text-sm text-gray-500">
                                                        {% if forloop.first %}
                                                        <span class="text-green-600 font-medium">Primary Input</span> → Processes uploaded files
                                                        {% elif forloop.last %}
                                                        <span class="text-purple-600 font-medium">Final Output</span> → Generates final results
                                                        {% else %}
                                                        <span class="text-blue-600 font-medium">Pipeline Step</span> → Uses output from previous tool
                                                        {% endif %}
                                                    </p>
                                                </div>
                                                {% if not forloop.last %}
                                                <div class="flex-shrink-0">
                                                    <i class="fas fa-arrow-right text-gray-400"></i>
                                                </div>
                                                {% endif %}
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    
                                    <!-- Reference Files (if needed) -->
                                    {% if template.id == 'variant-calling-pipeline' or template.id == 'rna-seq-pipeline' %}
                                    <div class="border border-gray-200 rounded-lg p-4">
                                        <h4 class="font-medium text-gray-900 mb-3">Reference Files</h4>
                                        <p class="text-sm text-gray-600 mb-3">Upload reference genome and annotation files if needed</p>
                                        
                                        <div class="space-y-3">
                                            {% if template.id == 'variant-calling-pipeline' %}
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Reference Genome (FASTA)</label>
                                                <input type="file" name="reference_genome" accept=".fasta,.fa,.fa.gz" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                            </div>
                                            {% endif %}
                                            
                                            {% if template.id == 'rna-seq-pipeline' %}
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">GTF/GFF Annotation File</label>
                                                <input type="file" name="annotation_file" accept=".gtf,.gff" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="mt-8 flex justify-end">
                            <button type="button" id="start-workflow-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-8 rounded-md transition duration-200 text-lg">
                                <i class="fas fa-play mr-2"></i>Start Workflow Pipeline
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="lg:col-span-1">
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Pipeline Information</h3>
                    
                    <!-- Template Details -->
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-medium text-gray-900">Template</h4>
                            <p class="text-sm text-gray-600">{{ template.name }}</p>
                        </div>
                        
                        <div>
                            <h4 class="font-medium text-gray-900">Category</h4>
                            <p class="text-sm text-gray-600">{{ template.category }}</p>
                        </div>
                        
                        <div>
                            <h4 class="font-medium text-gray-900">Estimated Time</h4>
                            <p class="text-sm text-gray-600">{{ template.estimated_time }}</p>
                        </div>
                        
                        <div>
                            <h4 class="font-medium text-gray-900">Difficulty</h4>
                            <p class="text-sm text-gray-600">{{ template.difficulty }}</p>
                        </div>
                    </div>
                    
                    <!-- Tools Used -->
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <h4 class="font-medium text-gray-900 mb-3">Tools in Pipeline</h4>
                        <div class="space-y-2">
                            {% for tool in template.tools %}
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0 w-8 h-8 {% if forloop.first %}bg-green-100 text-green-600{% elif forloop.last %}bg-purple-100 text-purple-600{% else %}bg-blue-100 text-blue-600{% endif %} rounded-full flex items-center justify-center">
                                    <span class="text-sm font-medium">{{ forloop.counter }}</span>
                                </div>
                                <div class="flex-1">
                                    <h5 class="font-medium text-gray-900">{{ tool|title }}</h5>
                                    <p class="text-sm text-gray-500">
                                        {% if tool == 'fastqc' %}
                                        Quality control analysis
                                        {% elif tool == 'trimmomatic' %}
                                        Read trimming and filtering
                                        {% elif tool == 'spades' %}
                                        Genome assembly
                                        {% elif tool == 'quast' %}
                                        Assembly quality assessment
                                        {% elif tool == 'bwa' %}
                                        Sequence alignment
                                        {% elif tool == 'samtools' %}
                                        SAM/BAM processing
                                        {% elif tool == 'gatk' %}
                                        Variant calling
                                        {% elif tool == 'star' %}
                                        RNA-seq alignment
                                        {% elif tool == 'muscle' %}
                                        Multiple sequence alignment
                                        {% else %}
                                        Bioinformatics analysis
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Expected Outputs -->
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <h4 class="font-medium text-gray-900 mb-3">Expected Outputs</h4>
                        <div class="space-y-2">
                            {% if template.output_formats %}
                                {% if template.output_formats|length > 0 %}
                                    {% for output in template.output_formats %}
                                    <div class="flex items-center text-sm text-gray-600">
                                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                        {{ output }}
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="flex items-center text-sm text-gray-600">
                                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                        Analysis Results
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="flex items-center text-sm text-gray-600">
                                    <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                    Analysis Results
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Pipeline Benefits -->
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <h4 class="font-medium text-gray-900 mb-3">Pipeline Benefits</h4>
                        <div class="space-y-2 text-sm text-gray-600">
                            <div class="flex items-center">
                                <i class="fas fa-arrow-right text-blue-500 mr-2"></i>
                                Automatic data flow between tools
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-arrow-right text-blue-500 mr-2"></i>
                                No manual file transfer needed
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-arrow-right text-blue-500 mr-2"></i>
                                Consistent data processing
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Progress Modal -->
<div id="upload-progress-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <!-- Modal Header -->
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Uploading Files & Queuing Workflow</h3>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600 hidden">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Progress Section -->
            <div class="space-y-6">
                <!-- Overall Progress -->
                <div>
                    <div class="flex justify-between text-sm text-gray-600 mb-2">
                        <span>Overall Progress</span>
                        <span id="overall-progress-text">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div id="overall-progress-bar" class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Upload Status -->
                <div id="upload-status" class="text-center py-4">
                    <div class="inline-flex items-center">
                        <i class="fas fa-spinner fa-spin text-blue-500 mr-2"></i>
                        <span class="text-gray-700">Preparing upload...</span>
                    </div>
                </div>
                
                <!-- File List -->
                <div id="file-list-container" class="max-h-64 overflow-y-auto border rounded-lg p-4 bg-gray-50">
                    <h4 class="font-medium text-gray-900 mb-3">Uploading Files</h4>
                    <div id="file-list" class="space-y-2">
                        <!-- Files will be added here dynamically -->
                    </div>
                </div>
                
                <!-- Validation Status -->
                <div id="validation-status" class="hidden">
                    <div class="flex items-center justify-center py-4">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        <span class="text-gray-700">Validating files...</span>
                    </div>
                </div>
                
                <!-- Workflow Start Status -->
                <div id="workflow-start-status" class="hidden">
                    <div class="flex items-center justify-center py-4">
                        <i class="fas fa-cogs fa-spin text-purple-500 mr-2"></i>
                        <span class="text-gray-700">Queuing workflow for execution...</span>
                    </div>
                </div>
                
                <!-- Success Status -->
                <div id="success-status" class="hidden text-center py-4">
                    <div class="inline-flex items-center">
                        <i class="fas fa-check-circle text-green-500 mr-2 text-2xl"></i>
                        <div>
                            <h4 class="text-lg font-medium text-gray-900">Workflow Queued Successfully!</h4>
                            <p class="text-sm text-gray-600">Your workflow has been queued for execution. The orchestrator service will process it automatically.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Error Status -->
                <div id="error-status" class="hidden text-center py-4">
                    <div class="inline-flex items-center">
                        <i class="fas fa-exclamation-circle text-red-500 mr-2 text-2xl"></i>
                        <div>
                            <h4 class="text-lg font-medium text-gray-900">Upload Failed</h4>
                            <p id="error-message" class="text-sm text-gray-600"></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-end mt-6 space-x-3">
                <button id="cancel-upload" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                    Cancel
                </button>
                <button id="retry-upload" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 hidden">
                    Retry
                </button>
                <button id="view-workflow" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 hidden">
                    View Workflow
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Enhanced drag and drop functionality
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('primary-files');
    const fileList = document.getElementById('primary-files-list');
    
    if (!dropZone || !fileInput || !fileList) {
        console.error('Required elements not found');
        return;
    }
    
    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    // Highlight drop zone when item is dragged over it
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });
    
    // Handle dropped files
    dropZone.addEventListener('drop', handleDrop, false);
    
    // Click to browse functionality
    dropZone.addEventListener('click', function() {
        fileInput.click();
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    function highlight(e) {
        dropZone.classList.add('border-blue-500', 'bg-blue-100');
        dropZone.classList.remove('border-blue-300');
    }
    
    function unhighlight(e) {
        dropZone.classList.remove('border-blue-500', 'bg-blue-100');
        dropZone.classList.add('border-blue-300');
    }
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            // Update the file input with dropped files
            fileInput.files = files;
            
            // Trigger the change event to update the file list
            const event = new Event('change', { bubbles: true });
            fileInput.dispatchEvent(event);
            
            // Show success message
            showFileUploadMessage('Files dropped successfully!', 'success');
        }
    }
    
    // File upload handling for primary files
    fileInput.addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        updateFileList(files);
        
        if (files.length > 0) {
            showFileUploadMessage(`${files.length} file(s) selected`, 'success');
        }
    });
    
    function updateFileList(files) {
        fileList.innerHTML = '';
        
        if (files.length === 0) {
            fileList.innerHTML = '<p class="text-sm text-gray-500 italic">No files selected</p>';
            return;
        }
        
        files.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'flex items-center justify-between p-3 bg-white border border-gray-200 rounded-md text-sm hover:bg-gray-50';
            
            const fileSize = (file.size / 1024 / 1024).toFixed(2);
            const fileType = getFileType(file.name);
            
            fileItem.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 ${getFileTypeColor(fileType)} rounded-full flex items-center justify-center">
                        <i class="fas ${getFileTypeIcon(fileType)} text-white text-xs"></i>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">${file.name}</span>
                        <p class="text-xs text-gray-500">${fileSize} MB • ${fileType.toUpperCase()}</p>
                    </div>
                </div>
                <button type="button" onclick="removeFile(${index})" class="text-red-500 hover:text-red-700">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            fileList.appendChild(fileItem);
        });
    }
    
    function getFileType(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        if (['fastq', 'fq'].includes(ext)) return 'fastq';
        if (['fasta', 'fa'].includes(ext)) return 'fasta';
        if (['bam'].includes(ext)) return 'bam';
        if (['sam'].includes(ext)) return 'sam';
        if (['vcf'].includes(ext)) return 'vcf';
        if (['gtf', 'gff'].includes(ext)) return 'annotation';
        return 'other';
    }
    
    function getFileTypeColor(fileType) {
        const colors = {
            'fastq': 'bg-blue-500',
            'fasta': 'bg-green-500',
            'bam': 'bg-purple-500',
            'sam': 'bg-purple-500',
            'vcf': 'bg-orange-500',
            'annotation': 'bg-indigo-500',
            'other': 'bg-gray-500'
        };
        return colors[fileType] || colors.other;
    }
    
    function getFileTypeIcon(fileType) {
        const icons = {
            'fastq': 'fa-dna',
            'fasta': 'fa-file-alt',
            'bam': 'fa-file-binary',
            'sam': 'fa-file-text',
            'vcf': 'fa-list',
            'annotation': 'fa-tags',
            'other': 'fa-file'
        };
        return icons[fileType] || icons.other;
    }
    
    // Make removeFile function global
    window.removeFile = function(index) {
        const dt = new DataTransfer();
        const files = Array.from(fileInput.files);
        
        files.splice(index, 1);
        files.forEach(file => dt.items.add(file));
        
        fileInput.files = dt.files;
        updateFileList(Array.from(fileInput.files));
        
        if (fileInput.files.length === 0) {
            showFileUploadMessage('All files removed', 'info');
        }
    };
    
    function showFileUploadMessage(message, type) {
        // Remove existing message
        const existingMessage = document.querySelector('.file-upload-message');
        if (existingMessage) {
            existingMessage.remove();
        }
        
        // Create new message
        const messageDiv = document.createElement('div');
        messageDiv.className = `file-upload-message mt-2 p-2 rounded-md text-sm ${
            type === 'success' ? 'bg-green-100 text-green-800' :
            type === 'error' ? 'bg-red-100 text-red-800' :
            'bg-blue-100 text-blue-800'
        }`;
        messageDiv.innerHTML = `
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'} mr-2"></i>
            ${message}
        `;
        
        fileList.parentNode.insertBefore(messageDiv, fileList);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.remove();
            }
        }, 3000);
    }
});

// Enhanced workflow upload functionality
let uploadSessionId = null;
let uploadInterval = null;

document.getElementById('start-workflow-btn').addEventListener('click', function() {
    const runName = document.getElementById('run_name').value.trim();
    const runDescription = document.getElementById('run_description').value.trim();
    const primaryFiles = document.getElementById('primary-files').files;
    
    if (!runName) {
        alert('Please provide a run name');
        return;
    }
    
    if (primaryFiles.length === 0) {
        alert('Please upload at least one primary input file to start the pipeline.');
        return;
    }
    
    // Show confirmation
    const toolCount = {{ template.tools|length }};
    const templateName = '{{ template.name }}';
    
    if (!confirm(`Start "${templateName}" pipeline with ${toolCount} tools?\n\nFiles will be uploaded and the pipeline will be queued for execution by the orchestrator service.`)) {
        return;
    }
    
    // Start the upload process
    startWorkflowUpload(runName, runDescription, primaryFiles);
});

async function startWorkflowUpload(runName, runDescription, files) {
    try {
        // Show modal
        showUploadModal();
        
        // Prepare file data
        const fileData = Array.from(files).map(file => ({
            name: file.name,
            size: file.size,
            type: file.type
        }));
        
        // Start upload session
        const response = await fetch(`/workflow/start-upload/{{ template.id }}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                run_name: runName,
                run_description: runDescription,
                files: fileData
            })
        });
        
        const result = await response.json();
        if (!result.success) {
            throw new Error(result.error);
        }
        
        uploadSessionId = result.run_id;
        updateFileList(files);
        
        // Start uploading files
        await uploadFiles(files);
        
        // Validate and start workflow
        await validateAndStartWorkflow();
        
    } catch (error) {
        console.error('Upload error:', error);
        showError(error.message);
    }
}

async function uploadFiles(files) {
    const fileArray = Array.from(files);
    
    for (let i = 0; i < fileArray.length; i++) {
        const file = fileArray[i];
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            const response = await fetch(`/workflow/upload-file/${uploadSessionId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            });
            
            const result = await response.json();
            if (!result.success) {
                throw new Error(result.error);
            }
            
            // Update file progress in UI
            updateFileProgress(file.name, 100, 'completed');
            
        } catch (error) {
            console.error(`Error uploading ${file.name}:`, error);
            updateFileProgress(file.name, 0, 'failed');
            throw error;
        }
    }
}

async function validateAndStartWorkflow() {
    try {
        // Show validation status
        document.getElementById('validation-status').classList.remove('hidden');
        document.getElementById('upload-status').classList.add('hidden');
        
        const response = await fetch(`/workflow/validate-and-start/${uploadSessionId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const result = await response.json();
        if (!result.success) {
            throw new Error(result.error);
        }
        
        // Show workflow start status
        document.getElementById('validation-status').classList.add('hidden');
        document.getElementById('workflow-start-status').classList.remove('hidden');
        
        // Show success immediately since workflow is queued for execution
        document.getElementById('workflow-start-status').classList.add('hidden');
        document.getElementById('success-status').classList.remove('hidden');
        
        // Update success message for new async workflow
        const successStatus = document.getElementById('success-status');
        const successMessage = successStatus.querySelector('h4');
        const successDescription = successStatus.querySelector('p');
        
        successMessage.textContent = 'Workflow Queued Successfully!';
        successDescription.textContent = 'Your workflow has been queued for execution. The orchestrator service will process it automatically.';
        
        // Redirect to workflow details
        setTimeout(() => {
            window.location.href = result.redirect_url;
        }, 2000);
        
    } catch (error) {
        console.error('Validation/start error:', error);
        showError(error.message);
    }
}

function showUploadModal() {
    document.getElementById('upload-progress-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function hideUploadModal() {
    document.getElementById('upload-progress-modal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

function updateFileList(files) {
    const fileList = document.getElementById('file-list');
    fileList.innerHTML = '';
    
    Array.from(files).forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'flex items-center justify-between p-3 bg-white border border-gray-200 rounded-md text-sm';
        fileItem.innerHTML = `
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                    <i class="fas fa-file text-white text-xs"></i>
                </div>
                <div>
                    <span class="font-medium text-gray-700">${file.name}</span>
                    <p class="text-xs text-gray-500">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-16 bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <span class="text-xs text-gray-500">0%</span>
            </div>
        `;
        fileItem.id = `file-${file.name}`;
        fileList.appendChild(fileItem);
    });
}

function updateFileProgress(fileName, progress, status) {
    const fileItem = document.getElementById(`file-${fileName}`);
    if (fileItem) {
        const progressBar = fileItem.querySelector('.bg-blue-600');
        const progressText = fileItem.querySelector('.text-xs');
        
        progressBar.style.width = `${progress}%`;
        progressText.textContent = `${progress}%`;
        
        if (status === 'completed') {
            progressBar.classList.add('bg-green-600');
            progressBar.classList.remove('bg-blue-600');
        } else if (status === 'failed') {
            progressBar.classList.add('bg-red-600');
            progressBar.classList.remove('bg-blue-600');
        }
    }
    
    // Update overall progress
    updateOverallProgress();
}

function updateOverallProgress() {
    const fileItems = document.querySelectorAll('#file-list > div');
    let totalProgress = 0;
    
    fileItems.forEach(item => {
        const progressText = item.querySelector('.text-xs');
        const progress = parseInt(progressText.textContent);
        totalProgress += progress;
    });
    
    const overallProgress = Math.round(totalProgress / fileItems.length);
    document.getElementById('overall-progress-bar').style.width = `${overallProgress}%`;
    document.getElementById('overall-progress-text').textContent = `${overallProgress}%`;
}

function showError(message) {
    document.getElementById('error-message').textContent = message;
    document.getElementById('error-status').classList.remove('hidden');
    document.getElementById('upload-status').classList.add('hidden');
    document.getElementById('validation-status').classList.add('hidden');
    document.getElementById('workflow-start-status').classList.add('hidden');
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Modal event listeners
document.getElementById('close-modal').addEventListener('click', hideUploadModal);
document.getElementById('cancel-upload').addEventListener('click', hideUploadModal);
document.getElementById('retry-upload').addEventListener('click', function() {
    hideUploadModal();
    // Retry logic can be implemented here
});
</script>
{% endblock %}
